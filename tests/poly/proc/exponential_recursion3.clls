type corec Gen(A) {
  offer of {
    |#next: send A; Gen(A)
    |#done: close
  }
};;

proc rec generateClones<A>(gen: Gen(A); a: ~A) {
  case gen of {
    |#next:
      send gen(x. call a(y); fwd x y);
      generateClones<A>(gen; a)
    |#done:
      close gen
  }
};;

proc main() {
  cut {
    let! a 71
    |a: ~!lint|
    generateClones<lint>(g; a)
    |g: ~Gen(lint)|
    #next g; recv g(x); println(x);
    #next g; recv g(y); println(y);
    #next g; recv g(z); println(z);
    #done g; wait g; ()
  }
};;
