type rec Nat {
    choice of {
        |#Z: close
        |#S: Nat
    }
};;

proc rec printNat(n: ~Nat) {
    println("U3"); unfold n;
    println("C"); case n of {
        |#Z: println("Z"); wait n; ()
        |#S: println("S"); printNat(n)
    }
};;

proc main() {
    cut {
        println("!");
        !n(n: Nat);
        println("U1"); unfold n;
        println("#S"); #S n;
        println("U2"); unfold n;
        println("#Z"); #Z n; close n
        |n: ?~Nat|
        println("?");
        ?n;
        par {
            call n(x);
            printNat(x)
            ||
            call n(y);
            printNat(y)
        }
    }
};;
